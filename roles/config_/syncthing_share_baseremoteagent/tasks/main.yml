---

 - name: Get hostname
   shell: hostname -s
   register: result

 - name: set xmppDomain = 1
   set_fact:
     XMPP_DOMAIN: "{{ result.stdout }}"

 - name: set LOCAL_DEVICE_ID
   set_fact:
     LOCAL_DEVICE_ID: syncthing -home=/var/lib/syncthing/.config/syncthing/ -device-id

 - name: shell
   shell: '{{ LOCAL_DEVICE_ID }}'
   register: deviceid

 - name: set LOCAL_DEVICE_ID
   set_fact:
     LOCAL_DEVICE_ID: "{{ deviceid.stdout }}"

 - name: delete file if present
   file:
     path: /var/lib/syncthing/baseremoteagent
     state: absent

 - name: create file
   file:
     path: /var/lib/pulse2/xmpp_baseremoteagent
     state: directory
     mode: '0755'

 - name: chown -R
   shell: 'chown -R syncthing: /var/lib/pulse2/xmpp_baseremoteagent'

 - name: shell
   shell: setfacl -Rdm g:syncthing:rwx /var/lib/pulse2/xmpp_baseremoteagent/

 - name: shell
   shell: setfacl -Rm g:syncthing:rwx /var/lib/pulse2/xmpp_baseremoteagent/

##
 - name: stman
   shell: stman folder add --label baseremoteagent --foldertype readonly /var/lib/pulse2/xmpp_baseremoteagent/ pulsemaster_baseremoteagent
   when:
     - XMPP_DOMAIN == 'pulse'

#######DELEGATE TO

 - name: shell stman
   shell: stman folder share pulsemaster_baseremoteagent {{ LOCAL_DEVICE_ID }}
   ignore_errors: yes
   delegate_to: pulse
   when:
     - SHARE_ADDED == '0'
     - XMPP_DOMAIN != 'pulse'

 - pause:
     seconds: 20

 - name: set SHARE_ADDED
   set_fact:
     SHARE_ADDED: xmlstarlet sel -t -c "configuration/folder[@id='pulsemaster_baseremoteagent']/device[@id='{{ LOCAL_DEVICE_ID }}']" /var/lib/syncthing/.config/syncthing/config.xml |wc -c
   delegate_to: pulse
   when:
     - XMPP_DOMAIN != 'pulse'

 - name: shell xmlstarlet
   shell: '{{ SHARE_ADDED }}'
   register: xmlout
   delegate_to: pulse
   when:
     - XMPP_DOMAIN != 'pulse'

 - name: set LOCAL_DEVICE_ID
   set_fact:
     SHARE_ADDED: "{{ xmlout.stdout }}"
   delegate_to: pulse
   when:
     - XMPP_DOMAIN != 'pulse'

 - name: shell stman
   shell: stman folder unshare pulsemaster_baseremoteagent {{ LOCAL_DEVICE_ID }}
   ignore_errors: yes
   delegate_to: pulse
   when:
     - SHARE_ADDED == '0'
     - XMPP_DOMAIN != 'pulse'

 - name: shell stman
   shell: stman folder share pulsemaster_baseremoteagent {{ LOCAL_DEVICE_ID }}
   ignore_errors: yes
   delegate_to: pulse
   when:
     - SHARE_ADDED == '0'
     - XMPP_DOMAIN != 'pulse'

 - name: set SHARE_ADDED
   set_fact:
     SHARE_ADDED: xmlstarlet sel -t -c "configuration/folder[@id='pulsemaster_baseremoteagent']/device[@id='{{ LOCAL_DEVICE_ID }}']" /var/lib/syncthing/.config/syncthing/config.xml |wc -c
   delegate_to: pulse
   when:
     - XMPP_DOMAIN != 'pulse'

##### END DELEGATE TO

 - name: restarted syncthing@syncthing
   systemd:
     name: syncthing@syncthing
     state: stopped
   when:
     - XMPP_DOMAIN != 'pulse'

 - name: Check if d folder is empty before proceeding
   find:
     paths: '/var/lib/syncthing/baseremoteagent/'
   register: filesFound

 - name: Move foo to bar
   command: mv /var/lib/syncthing/baseremoteagent/.st*  /var/lib/pulse2/xmpp_baseremoteagent/
   when:
     - XMPP_DOMAIN != 'pulse'
     - filesFound.matched > 0

 - name: delete file if present
   file:
     path: /var/lib/syncthing/baseremoteagent
     state: absent
   when:
     - XMPP_DOMAIN != 'pulse'

 - name: shell
   shell: xmlstarlet ed --inplace -u "configuration/folder[@id='pulsemaster_baseremoteagent']/@path" -v "/var/lib/pulse2/xmpp_baseremoteagent" /var/lib/syncthing/.config/syncthing/config.xml
   when:
     - XMPP_DOMAIN != 'pulse'

 - name: restarted syncthing@syncthing
   systemd:
     name: syncthing@syncthing
     state: restarted
   when:
     - XMPP_DOMAIN != 'pulse'

 - pause:
     seconds: 5
   when:
     - XMPP_DOMAIN != 'pulse'
